@page "/task-step-view/{TaskId:int}/step/{StepId:int}"
@using OverblikPlus.Dtos.TaskSteps
@using OverblikPlus.Services.Interfaces
@inject ITaskStepService TaskStepService
@inject NavigationManager Navigation
@inject IJSRuntime Js

<h3>Opgave Trin - Trin @(currentStepIndex + 1) af @TaskSteps.Count</h3>

@if (TaskSteps == null || !TaskSteps.Any())
{
    <p>Ingen trin fundet for denne opgave.</p>
}
else if (currentStep == null)
{
    <p>Indlæser trin...</p>
}
else
{
    <div class="text-center">
        @if (!string.IsNullOrEmpty(currentStep.Image))
        {
            <img src="@currentStep.Image" alt="Trin billede" width="300" class="mb-3" />
        }
        <p>@currentStep.Text</p>

        @if (currentStep.RequiresQrCodeScan)
        {
            <button class="btn btn-secondary" @onclick="StartScanning">Scan QR-kode for at fortsætte</button>
            <div id="qr-scanner" style="display: @(isScanning ? "block" : "none");">
                <video id="video" style="width: 100%; height: auto;"></video>
                <button @onclick="StopScanning">Annuller</button>
            </div>
        }
        else
        {
            <button class="btn btn-primary" @onclick="ShowNextStep">Næste trin</button>
        }
    </div>
}

@code {
    [Parameter] public int TaskId { get; set; }
    [Parameter] public int StepId { get; set; }

    private List<ReadTaskStepDto> TaskSteps { get; set; } = new();
    private ReadTaskStepDto? currentStep;
    private int currentStepIndex = 0;
    private bool isScanning = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTaskSteps();

        if (TaskSteps.Any())
        {
            currentStepIndex = TaskSteps.FindIndex(step => step.Id == StepId);
            if (currentStepIndex == -1)
            {
                currentStepIndex = 0; // Fallback if StepId not found
            }
            currentStep = TaskSteps[currentStepIndex];
        }
    }

    private async Task LoadTaskSteps()
    {
        try
        {
            Console.WriteLine("Kalder GetStepsForTask for TaskId: " + TaskId);
            TaskSteps = await TaskStepService.GetStepsForTask(TaskId) ?? new List<ReadTaskStepDto>();

            Console.WriteLine("Antal trin hentet: " + TaskSteps.Count);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved hentning af trin: {ex.Message}");
        }
    }

    private async Task ShowNextStep()
    {
        if (currentStepIndex < TaskSteps.Count - 1)
        {
            currentStepIndex++;
            currentStep = TaskSteps[currentStepIndex];
            Navigation.NavigateTo($"/task-step-view/{TaskId}/step/{currentStep.Id}");
        }
        else
        {
            Navigation.NavigateTo("/tasks");
        }
    }

    public async Task StartScanning()
    {
        Console.WriteLine("StartScanning kaldt i TaskStepView");

        if (!isScanning)
        {
            isScanning = true;
            await Js.InvokeVoidAsync("startScanning");
        }
    }

    public async Task StopScanning()
    {
        await Js.InvokeVoidAsync("stopScanning");
        isScanning = false;
    }

    [JSInvokable]
    public async Task OnQrCodeScanned(string result)
    {
        await StopScanning();
        await ShowNextStep();
    }
}
