@page "/task-step-view/{TaskId:int}"
@using OverblikPlus.Dtos
@using OverblikPlus.Dtos.TaskSteps
@using OverblikPlus.Services.Interfaces
@inject ITaskStepService TaskStepService
@inject NavigationManager Navigation

<h3>Opgave Trin - Trin @(currentStepIndex + 1)</h3>

@if (TaskSteps == null || !TaskSteps.Any())
{
    <p>Ingen trin fundet for denne opgave.</p>
}
else if (currentStep == null)
{
    <p>Indlæser trin...</p>
}
else
{
    <div>
        <img src="@currentStep.ImageUrl" alt="Trin billede" width="300" style="display: block; margin: auto;" />
        <p style="text-align: center;">@currentStep.Text</p>
        
        @if (currentStepIndex < TaskSteps.Count - 1)
        {
            <button @onclick="ShowNextStep">Næste trin</button>
        }
        else
        {
            <p>Du har nået det sidste trin.</p>
        }
    </div>
}

@code {
    [Parameter] public int TaskId { get; set; }

    private List<ReadTaskStepDto> TaskSteps = new();
    private ReadTaskStepDto? currentStep;
    private int currentStepIndex = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadTaskSteps();

        if (TaskSteps.Any())
        {
            currentStep = TaskSteps[currentStepIndex];
        }
    }

    private async Task LoadTaskSteps()
    {
        try
        {
            TaskSteps = await TaskStepService.GetStepsForTask(TaskId) ?? new List<ReadTaskStepDto>();
            
            Console.WriteLine($"Hentede {TaskSteps.Count} trin for task med ID: {TaskId}");

            if (!TaskSteps.Any())
            {
                Console.WriteLine($"Ingen trin fundet for task med ID: {TaskId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved hentning af trin: {ex.Message}");
        }
    }

    private void ShowNextStep()
    {
        if (currentStepIndex < TaskSteps.Count - 1)
        {
            currentStepIndex++;
            currentStep = TaskSteps[currentStepIndex];
        }
    }
}
