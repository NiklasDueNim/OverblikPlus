@page "/admin/tasks"
@using AutoMapper
@using OverblikPlus.Dtos.Tasks
@using OverblikPlus.Dtos.TaskSteps
@using OverblikPlus.Dtos.User
@using OverblikPlus.Services.Interfaces
@using OverblikPlus.Components
@inject ITaskService TaskService
@inject IUserService UserService
@inject ITaskStepService TaskStepService
@inject IMapper Mapper

<div class="container mt-4">
    <h3 class="mb-4">Administrer Opgaver</h3>

    <!-- Knap til at oprette en ny opgave -->
    <button class="btn btn-success mb-3" @onclick="CreateTask">Opret Ny Opgave</button>

    @if (isTaskFormVisible)
    {
        <TaskForm Title="@(isEditMode ? "Rediger Opgave" : "Opret Ny Opgave")" 
                  Task="taskFormModel" 
                  Users="users" 
                  OnSave="SaveTask" 
                  OnCancel="CancelTaskForm" />
    }

    <hr />

    <TaskOverviewComponent Tasks="Tasks" 
                           OnEditTask="EditTask" 
                           OnDeleteTask="DeleteTask" 
                           OnAddStep="AddStep" 
                           OnEditStep="EditStep" 
                           OnDeleteStep="OnDeleteStepHandler" />

    @if (isStepFormVisible)
    {
        <TaskStepForm Step="currentStep" OnSave="SaveStep" OnCancel="CancelStepForm" />
    }
</div>

@code {
    private List<ReadTaskDto> Tasks { get; set; } = new List<ReadTaskDto>();
    private List<ReadUserDto> users = new List<ReadUserDto>();
    private TaskFormModel taskFormModel = new TaskFormModel();
    private bool isEditMode = false;
    private bool isTaskFormVisible = false;
    private bool isStepFormVisible = false;
    private TaskStepFormModel currentStep = new TaskStepFormModel(); 
    private bool isEditStepMode = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
        await LoadUsers();
    }

    private async Task LoadTasks()
    {
        Tasks = await TaskService.GetAllTasks();
    }

    private async Task LoadUsers()
    { 
        users = (await UserService.GetAllUsers()).ToList();
    }

    private void CreateTask()
    {
        taskFormModel = new TaskFormModel();
        isEditMode = false;
        isTaskFormVisible = true;
    }

    private void EditTask(ReadTaskDto task)
    {
        taskFormModel = Mapper.Map<TaskFormModel>(task);
        isEditMode = true;
        isTaskFormVisible = true;
    }

    private async Task SaveTask()
    {
        try
        {
            if (isEditMode)
            {
                Console.WriteLine($"Opdaterer opgave med ID {taskFormModel.Id}");
                var updateTaskDto = Mapper.Map<UpdateTaskDto>(taskFormModel);
                await TaskService.UpdateTask(updateTaskDto.Id, updateTaskDto);
            }
            else
            {
                Console.WriteLine("Opretter ny opgave");
                var createTaskDto = Mapper.Map<CreateTaskDto>(taskFormModel);
                await TaskService.CreateTask(createTaskDto);
            }
        
            await LoadTasks();
            isTaskFormVisible = false;
            ResetForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl i SaveTask: {ex.Message}");
        }
    }

    private void ResetForm()
    {
        taskFormModel = new TaskFormModel();
        isEditMode = false;
    }

    private void CancelTaskForm()
    {
        isTaskFormVisible = false;
        ResetForm();
    }

    private async Task DeleteTask(int taskId)
    {
        await TaskService.DeleteTask(taskId);
        await LoadTasks();
    }

    private void AddStep(int taskId)
    {
        currentStep = new TaskStepFormModel { TaskId = taskId };
        isEditStepMode = false;
        isStepFormVisible = true;
    }

    private void EditStep(ReadTaskStepDto step)
    {
        currentStep = Mapper.Map<TaskStepFormModel>(step);
        isEditStepMode = true;
        isStepFormVisible = true;
    }

    private async Task SaveStep()
    {
        try
        {
            if (isEditStepMode)
            {
                Console.WriteLine($"Opdaterer trin ID {currentStep.Id} for opgave ID {currentStep.TaskId}");
                var updateStepDto = Mapper.Map<UpdateTaskStepDto>(currentStep);
                await TaskStepService.UpdateTaskStep(updateStepDto.TaskId, updateStepDto.Id, updateStepDto);
            }
            else
            {
                Console.WriteLine($"Opretter nyt trin for opgave ID {currentStep.TaskId}");
                var createStepDto = Mapper.Map<CreateTaskStepDto>(currentStep);
                await TaskStepService.CreateTaskStep(createStepDto);
            }

            await UpdateTaskSteps(currentStep.TaskId);
            isStepFormVisible = false;
            ResetStepForm();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl i SaveStep: {ex.Message}");
        }
    }

    private void ResetStepForm()
    {
        currentStep = new TaskStepFormModel();
        isEditStepMode = false;
    }

    private void CancelStepForm()
    {
        isStepFormVisible = false;
        ResetStepForm();
    }

    private async Task UpdateTaskSteps(int taskId)
    {
        var updatedSteps = await TaskStepService.GetStepsForTask(taskId);
        var index = Tasks.FindIndex(t => t.Id == taskId);
        if (index >= 0)
        {
            var task = Tasks[index];
            Tasks[index] = new ReadTaskDto
            {
                Id = task.Id,
                Name = task.Name,
                Description = task.Description,
                Image = task.Image,
                UserId = task.UserId,
                Steps = updatedSteps
            };
            StateHasChanged();
        }
    }

    private async Task DeleteStep(int taskId, int stepId)
    {
        await TaskStepService.DeleteTaskStep(taskId, stepId);
        await UpdateTaskSteps(taskId);
    }

    private Task OnDeleteStepHandler(int stepId)
    {
        var task = Tasks.FirstOrDefault(t => t.Steps.Any(s => s.Id == stepId));
        if (task != null)
        {
            int taskId = task.Id;
            return DeleteStep(taskId, stepId);
        }
        else
        {
            Console.WriteLine("Kunne ikke finde opgaven for det givne trin");
            return Task.CompletedTask;
        }
    }
}
